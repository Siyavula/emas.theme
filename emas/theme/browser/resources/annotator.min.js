(function(){var h,o,b,g,p,i,l,q,a,e,n,d,c,t,u,j,r,m=[].slice,k={}.hasOwnProperty,f=function(v,w){return function(){return v.apply(w,arguments)}},s=function(y,w){for(var v in w){if(k.call(w,v)){y[v]=w[v]}}function x(){this.constructor=y}x.prototype=w.prototype;y.prototype=new x;y.__super__=w.prototype;return y};q=null;if(typeof Gettext!=="undefined"&&Gettext!==null){n=new Gettext({domain:"annotator"});q=function(v){return n.gettext(v)}}else{q=function(v){return v}}r=function(v){return q(v)};if(!(typeof jQuery!=="undefined"&&jQuery!==null?(j=jQuery.fn)!=null?j.jquery:void 0:void 0)){console.error(r("Annotator requires jQuery: have you included lib/vendor/jquery.js?"))}if(!(JSON&&JSON.parse&&JSON.stringify)){console.error(r("Annotator requires a JSON implementation: have you included lib/vendor/json2.js?"))}h=jQuery.sub();h.flatten=function(w){var v;v=function(y){var z,B,A,x;B=[];for(A=0,x=y.length;A<x;A++){z=y[A];B=B.concat(z&&h.isArray(z)?v(z):z)}return B};return v(w)};h.plugin=function(w,v){return jQuery.fn[w]=function(y){var x;x=Array.prototype.slice.call(arguments,1);return this.each(function(){var z;z=h.data(this,w);if(z){return y&&z[y].apply(z,x)}else{z=new v(this,y);return h.data(this,w,z)}})}};h.fn.textNodes=function(){var v;v=function(x){var w;if(x&&x.nodeType!==3){w=[];if(x.nodeType!==8){x=x.lastChild;while(x){w.push(v(x));x=x.previousSibling}}return w.reverse()}else{return x}};return this.map(function(){return h.flatten(v(this))})};h.fn.xpath=function(v){var w;w=this.map(function(){var y,x,z;z="";y=this;while(y&&y.nodeType===1&&y!==v){x=h(y.parentNode).children(y.tagName).index(y)+1;x=x>1?"["+x+"]":"";z="/"+y.tagName.toLowerCase()+x+z;y=y.parentNode}return z});return w.get()};h.escape=function(v){return v.replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};h.fn.escape=function(v){if(arguments.length){return this.html(h.escape(v))}return this.html()};l=["log","debug","info","warn","exception","assert","dir","dirxml","trace","group","groupEnd","groupCollapsed","time","timeEnd","profile","profileEnd","count","clear","table","error","notifyFirebug","firebug","userObjects"];if(typeof console!=="undefined"&&console!==null){if(!(console.group!=null)){console.group=function(v){return console.log("GROUP: ",v)}}if(!(console.groupCollapsed!=null)){console.groupCollapsed=console.group}for(d=0,t=l.length;d<t;d++){i=l[d];if(!(console[i]!=null)){console[i]=function(){return console.log(r("Not implemented:")+(" console."+name))}}}}else{this.console={};for(c=0,u=l.length;c<u;c++){i=l[c];this.console[i]=function(){}}this.console.error=function(){var v;v=1<=arguments.length?m.call(arguments,0):[];return alert("ERROR: "+(v.join(", ")))};this.console.warn=function(){var v;v=1<=arguments.length?m.call(arguments,0):[];return alert("WARNING: "+(v.join(", ")))}}b=(function(){v.name="Delegator";v.prototype.events={};v.prototype.options={};v.prototype.element=null;function v(x,w){this.options=h.extend(true,{},this.options,w);this.element=h(x);this.on=this.subscribe;this.addEvents()}v.prototype.addEvents=function(){var A,C,B,x,z,w,D,y;w=this.events;y=[];for(B in w){C=w[B];D=B.split(" "),x=2<=D.length?m.call(D,0,z=D.length-1):(z=0,[]),A=D[z++];y.push(this.addEvent(x.join(" "),A,C))}return y};v.prototype.addEvent=function(w,y,z){var B,x,A=this;B=function(){return A[z].apply(A,arguments)};x=typeof w==="string"&&w.replace(/\s+/g,"")==="";if(x){w=this.element}if(typeof w==="string"){this.element.delegate(w,y,B)}else{if(this.isCustomEvent(y)){this.subscribe(y,B)}else{h(w).bind(y,B)}}return this};v.prototype.isCustomEvent=function(w){w=w.split(".")[0];return h.inArray(w,v.natives)===-1};v.prototype.publish=function(){this.element.triggerHandler.apply(this.element,arguments);return this};v.prototype.subscribe=function(w,y){var x;x=function(){return y.apply(this,[].slice.call(arguments,1))};x.guid=y.guid=(h.guid+=1);this.element.bind(w,x);return this};v.prototype.unsubscribe=function(){this.element.unbind.apply(this.element,arguments);return this};return v})();b.natives=(function(){var w,v,x;v=(function(){var y,z;y=jQuery.event.special;z=[];for(w in y){if(!k.call(y,w)){continue}x=y[w];z.push(w)}return z})();return"blur focus focusin focusout load resize scroll unload click dblclick\nmousedown mouseup mousemove mouseover mouseout mouseenter mouseleave\nchange select submit keydown keypress keyup error".split(/[^a-z]+/).concat(v)})();p={};p.sniff=function(v){if(v.commonAncestorContainer!=null){return new p.BrowserRange(v)}else{if(typeof v.start==="string"){return new p.SerializedRange(v)}else{if(v.start&&typeof v.start==="object"){return new p.NormalizedRange(v)}else{console.error(r("Could not sniff range type"));return false}}}};p.BrowserRange=(function(){v.name="BrowserRange";function v(w){this.commonAncestorContainer=w.commonAncestorContainer;this.startContainer=w.startContainer;this.startOffset=w.startOffset;this.endContainer=w.endContainer;this.endOffset=w.endOffset}v.prototype.normalize=function(E){var D,z,F,C,y,w,A,x,B;if(this.tainted){console.error(r("You may only call normalize() once on a BrowserRange!"));return false}else{this.tainted=true}w={};F={};B=["start","end"];for(A=0,x=B.length;A<x;A++){y=B[A];z=this[y+"Container"];C=this[y+"Offset"];if(z.nodeType===1){D=z.childNodes[C];z=D||z.childNodes[C-1];if(z.nodeType===1&&!z.firstChild){D=null;z=z.previousSibling}while(z.nodeType!==3){z=z.firstChild}C=D?0:z.nodeValue.length}w[y]=z;w[y+"Offset"]=C}F.start=w.startOffset>0?w.start.splitText(w.startOffset):w.start;if(w.start===w.end){if((w.endOffset-w.startOffset)<F.start.nodeValue.length){F.start.splitText(w.endOffset-w.startOffset)}F.end=F.start}else{if(w.endOffset<w.end.nodeValue.length){w.end.splitText(w.endOffset)}F.end=w.end}F.commonAncestor=this.commonAncestorContainer;while(F.commonAncestor.nodeType!==1){F.commonAncestor=F.commonAncestor.parentNode}return new p.NormalizedRange(F)};v.prototype.serialize=function(w,x){return this.normalize(w).serialize(w,x)};return v})();p.NormalizedRange=(function(){v.name="NormalizedRange";function v(w){this.commonAncestor=w.commonAncestor;this.start=w.start;this.end=w.end}v.prototype.normalize=function(w){return this};v.prototype.limit=function(C){var y,B,z,A,x,w;y=h.grep(this.textNodes(),function(D){return D.parentNode===C||h.contains(C,D.parentNode)});if(!y.length){return null}this.start=y[0];this.end=y[y.length-1];z=h(this.start).parents();w=h(this.end).parents();for(A=0,x=w.length;A<x;A++){B=w[A];if(z.index(B)!==-1){this.commonAncestor=B;break}}return this};v.prototype.serialize=function(y,z){var x,w,A;w=function(F,E){var D,C,H,K,J,I,G,B;if(z){K=h(F).parents(":not("+z+")").eq(0)}else{K=h(F).parent()}I=K.xpath(y)[0];J=K.textNodes();C=J.slice(0,J.index(F));H=0;for(G=0,B=C.length;G<B;G++){D=C[G];H+=D.nodeValue.length}if(E){return[I,H+F.nodeValue.length]}else{return[I,H]}};A=w(this.start);x=w(this.end,true);return new p.SerializedRange({start:A[0],end:x[0],startOffset:A[1],endOffset:x[1]})};v.prototype.text=function(){var w;return((function(){var A,y,x,z;x=this.textNodes();z=[];for(A=0,y=x.length;A<y;A++){w=x[A];z.push(w.nodeValue)}return z}).call(this)).join("")};v.prototype.textNodes=function(){var x,z,y,w;y=h(this.commonAncestor).textNodes();w=[y.index(this.start),y.index(this.end)],z=w[0],x=w[1];return h.makeArray(y.slice(z,x+1||9000000000))};v.prototype.toRange=function(){var w;w=document.createRange();w.setStartBefore(this.start);w.setEndAfter(this.end);return w};return v})();p.SerializedRange=(function(){v.name="SerializedRange";function v(w){this.start=w.start;this.startOffset=w.startOffset;this.end=w.end;this.endOffset=w.endOffset}v.prototype._nodeFromXPath=function(w){var B,A,x,z,y;A=function(D,C){if(C==null){C=null}return document.evaluate(D,document,C,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue};if(!h.isXMLDoc(document.documentElement)){return A(w)}else{B=document.createNSResolver(document.ownerDocument===null?document.documentElement:document.ownerDocument.documentElement);z=A(w,B);if(!z){w=((function(){var F,D,C,E;C=w.split("/");E=[];for(F=0,D=C.length;F<D;F++){y=C[F];if(y&&y.indexOf(":")===-1){E.push(y.replace(/^([a-z]+)/,"xhtml:$1"))}else{E.push(y)}}return E})()).join("/");x=document.lookupNamespaceURI(null);B=function(C){if(C==="xhtml"){return x}else{return document.documentElement.getAttribute("xmlns:"+C)}};z=A(w,B)}return z}};v.prototype.normalize=function(J){var M,G,F,L,D,I,K,H,E,B,y,x,O,N,w,C,A,z;K=h(J).xpath()[0];E=this.start.split("/");F=this.end.split("/");G=[];H={};for(L=y=0,C=E.length;0<=C?y<C:y>C;L=0<=C?++y:--y){if(E[L]===F[L]){G.push(E[L])}else{break}}M=K+G.join("/");H.commonAncestorContainer=this._nodeFromXPath(M);if(!H.commonAncestorContainer){console.error(r("Error deserializing range: can't find XPath '")+M+r("'. Is this the right document?"));return null}A=["start","end"];for(x=0,O=A.length;x<O;x++){I=A[x];D=0;z=h(this._nodeFromXPath(K+this[I])).textNodes();for(w=0,N=z.length;w<N;w++){B=z[w];if(D+B.nodeValue.length>=this[I+"Offset"]){H[I+"Container"]=B;H[I+"Offset"]=this[I+"Offset"]-D;break}else{D+=B.nodeValue.length}}}return new p.BrowserRange(H).normalize(J)};v.prototype.serialize=function(w,x){return this.normalize(w).serialize(w,x)};v.prototype.toObject=function(){return{start:this.start,startOffset:this.startOffset,end:this.end,endOffset:this.endOffset}};return v})();a={uuid:(function(){var v;v=0;return function(){return v++}})(),getGlobal:function(){return(function(){return this})()},mousePosition:function(v,x){var w;w=h(x).offset();return{top:v.pageY-w.top,left:v.pageX-w.left}},preventEventDefault:function(v){return v!=null?typeof v.preventDefault==="function"?v.preventDefault():void 0:void 0}};e=this.Annotator;o=(function(v){s(w,v);w.name="Annotator";w.prototype.events={".annotator-adder button click":"onAdderClick",".annotator-adder button mousedown":"onAdderMousedown",".annotator-hl mouseover":"onHighlightMouseover",".annotator-hl mouseout":"startViewerHideTimer"};w.prototype.html={hl:'<span class="annotator-hl"></span>',adder:'<div class="annotator-adder"><button>'+r("Annotate")+"</button></div>",wrapper:'<div class="annotator-wrapper"></div>'};w.prototype.options={readOnly:false};w.prototype.plugins={};w.prototype.editor=null;w.prototype.viewer=null;w.prototype.selectedRanges=null;w.prototype.mouseIsDown=false;w.prototype.ignoreMouseup=false;w.prototype.viewerHideTimer=null;function w(A,z){this.onDeleteAnnotation=f(this.onDeleteAnnotation,this);this.onEditAnnotation=f(this.onEditAnnotation,this);this.onAdderClick=f(this.onAdderClick,this);this.onAdderMousedown=f(this.onAdderMousedown,this);this.onHighlightMouseover=f(this.onHighlightMouseover,this);this.checkForEndSelection=f(this.checkForEndSelection,this);this.checkForStartSelection=f(this.checkForStartSelection,this);this.clearViewerHideTimer=f(this.clearViewerHideTimer,this);this.startViewerHideTimer=f(this.startViewerHideTimer,this);this.showViewer=f(this.showViewer,this);this.onEditorSubmit=f(this.onEditorSubmit,this);this.onEditorHide=f(this.onEditorHide,this);this.showEditor=f(this.showEditor,this);var y,B,x;w.__super__.constructor.apply(this,arguments);this.plugins={};if(!w.supported()){return this}if(!this.options.readOnly){this._setupDocumentEvents()}this._setupWrapper()._setupViewer()._setupEditor();x=this.html;for(y in x){B=x[y];if(y!=="wrapper"){this[y]=h(B).appendTo(this.wrapper).hide()}}}w.prototype._setupWrapper=function(){this.wrapper=h(this.html.wrapper);this.element.find("script").remove();this.element.wrapInner(this.wrapper);this.wrapper=this.element.find(".annotator-wrapper");return this};w.prototype._setupViewer=function(){var x=this;this.viewer=new w.Viewer({readOnly:this.options.readOnly});this.viewer.hide().on("edit",this.onEditAnnotation).on("delete",this.onDeleteAnnotation).addField({load:function(z,y){if(y.text){h(z).escape(y.text)}else{h(z).html("<i>"+(r("No Comment"))+"</i>")}return x.publish("annotationViewerTextField",[z,y])}}).element.appendTo(this.wrapper).bind({mouseover:this.clearViewerHideTimer,mouseout:this.startViewerHideTimer});return this};w.prototype._setupEditor=function(){this.editor=new w.Editor();this.editor.hide().on("hide",this.onEditorHide).on("save",this.onEditorSubmit).addField({type:"textarea",label:r("Comments")+"\u2026",load:function(y,x){return h(y).find("textarea").val(x.text||"")},submit:function(y,x){return x.text=h(y).find("textarea").val()}});this.editor.element.appendTo(this.wrapper);return this};w.prototype._setupDocumentEvents=function(){h(document).bind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection});return this};w.prototype.getSelectedRanges=function(){var A,D,B,x,z,E,F,C,y;F=a.getGlobal().getSelection();z=[];E=[];if(!F.isCollapsed){z=(function(){var I,G,H;H=[];for(D=I=0,G=F.rangeCount;0<=G?I<G:I>G;D=0<=G?++I:--I){x=F.getRangeAt(D);A=new p.BrowserRange(x);B=A.normalize().limit(this.wrapper[0]);if(B===null){E.push(x)}H.push(B)}return H}).call(this);F.removeAllRanges()}for(C=0,y=E.length;C<y;C++){x=E[C];F.addRange(x)}return h.grep(z,function(G){if(G){F.addRange(G.toRange())}return G})};w.prototype.createAnnotation=function(){var x;x={};this.publish("beforeAnnotationCreated",[x]);return x};w.prototype.setupAnnotation=function(y,A){var z,E,D,B,C,x;if(A==null){A=true}y.ranges||(y.ranges=this.selectedRanges);E=(function(){var I,G,F,H;F=y.ranges;H=[];for(I=0,G=F.length;I<G;I++){D=F[I];B=p.sniff(D);H.push(B.normalize(this.wrapper[0]))}return H}).call(this);E=h.grep(E,function(F){return F!==null});y.quote=[];y.ranges=[];y.highlights=[];for(C=0,x=E.length;C<x;C++){z=E[C];y.quote.push(h.trim(z.text()));y.ranges.push(z.serialize(this.wrapper[0],".annotator-hl"));h.merge(y.highlights,this.highlightRange(z))}y.quote=y.quote.join(" / ");h(y.highlights).data("annotation",y);if(this.plugins.Categories){this.plugins.Categories.setHighlights(y)}if(this.plugins.RoundupStatus){if(!(y.status!=null)){y.status="new"}}if(A){this.publish("annotationCreated",[y])}return y};w.prototype.updateAnnotation=function(x){this.publish("beforeAnnotationUpdated",[x]);this.publish("annotationUpdated",[x]);return x};w.prototype.deleteAnnotation=function(z){var B,A,y,x;x=z.highlights;for(A=0,y=x.length;A<y;A++){B=x[A];h(B).replaceWith(B.childNodes)}this.publish("annotationDeleted",[z]);return z};w.prototype.loadAnnotations=function(y){var A,x,z=this;if(y==null){y=[]}x=function(E){var F,C,D,B;if(E==null){E=[]}C=E.splice(0,10);for(D=0,B=C.length;D<B;D++){F=C[D];z.setupAnnotation(F,false)}if(E.length>0){return setTimeout((function(){return x(E)}),100)}else{return z.publish("annotationsLoaded",[A])}};A=y.slice();if(y.length){x(y)}return this};w.prototype.dumpAnnotations=function(){if(this.plugins.Store){return this.plugins.Store.dumpAnnotations()}else{return console.warn(r("Can't dump annotations without Store plugin."))}};w.prototype.highlightRange=function(C){var D,A,B,y,x,z;A=/^\s*$/;x=C.textNodes();z=[];for(B=0,y=x.length;B<y;B++){D=x[B];if(!A.test(D.nodeValue)){z.push(h(D).wrapAll(this.hl).parent().show()[0])}}return z};w.prototype.addPlugin=function(z,y){var x,A;if(this.plugins[z]){console.error(r("You cannot have more than one instance of any plugin."))}else{x=w.Plugin[z];if(typeof x==="function"){this.plugins[z]=new x(this.element[0],y);this.plugins[z].annotator=this;if(typeof(A=this.plugins[z]).pluginInit==="function"){A.pluginInit()}}else{console.error(r("Could not load ")+z+r(" plugin. Have you included the appropriate <script> tag?"))}}return this};w.prototype.showEditor=function(x,y){this.editor.element.css(y);this.editor.load(x);return this};w.prototype.onEditorHide=function(){this.publish("annotationEditorHidden",[this.editor]);return this.ignoreMouseup=false};w.prototype.onEditorSubmit=function(x){this.publish("annotationEditorSubmit",[this.editor,x]);if(x.ranges===void 0){return this.setupAnnotation(x)}else{return this.updateAnnotation(x)}};w.prototype.showViewer=function(y,x){this.viewer.element.css(x);this.viewer.load(y);return this.publish("annotationViewerShown",[this.viewer,y])};w.prototype.startViewerHideTimer=function(){if(!this.viewerHideTimer){return this.viewerHideTimer=setTimeout(this.viewer.hide,250)}};w.prototype.clearViewerHideTimer=function(){clearTimeout(this.viewerHideTimer);return this.viewerHideTimer=false};w.prototype.checkForStartSelection=function(x){if(!x){this.startViewerHideTimer();return this.mouseIsDown=true}};w.prototype.checkForEndSelection=function(C){var z,A,B,y,x;this.mouseIsDown=false;if(this.ignoreMouseup){return}this.selectedRanges=this.getSelectedRanges();x=this.selectedRanges;for(B=0,y=x.length;B<y;B++){A=x[B];z=A.commonAncestor;if(this.isAnnotatorViewer(z)){return}if(this.isAnnotatorEditor(z)){return}if(this.isAnnotatorWidget(z)){return}}if(C&&this.selectedRanges.length){return this.adder.css(a.mousePosition(C,this.wrapper[0])).show()}else{return this.adder.hide()}};w.prototype.isAnnotator=function(x){return !!h(x).parents().andSelf().filter("[class^=annotator-]").not(this.wrapper).length};w.prototype.isAnnotatorViewer=function(x){return !!h(x).parents().andSelf().filter("[class^=annotator-viewer]").not(this.wrapper).length};w.prototype.isAnnotatorEditor=function(x){return !!h(x).parents().andSelf().filter("[class^=annotator-editor]").not(this.wrapper).length};w.prototype.isAnnotatorWidget=function(x){return !!h(x).parents().andSelf().filter("[class^=annotator-widget]").not(this.wrapper).length};w.prototype.onHighlightMouseover=function(x){var y;this.clearViewerHideTimer();if(this.mouseIsDown||this.viewer.isShown()){return false}y=h(x.target).parents(".annotator-hl").andSelf().map(function(){return h(this).data("annotation")});return this.showViewer(h.makeArray(y),a.mousePosition(x,this.wrapper[0]))};w.prototype.onAdderMousedown=function(x){if(x!=null){x.preventDefault()}return this.ignoreMouseup=true};w.prototype.onAdderClick=function(y){var x;if(y!=null){y.preventDefault()}x=this.adder.position();this.adder.hide();return this.showEditor(this.createAnnotation(),x)};w.prototype.onEditAnnotation=function(x){var y;y=this.viewer.element.position();this.viewer.hide();return this.showEditor(x,y)};w.prototype.onDeleteAnnotation=function(x){this.viewer.hide();return this.deleteAnnotation(x)};return w})(b);o.Plugin=(function(w){s(v,w);v.name="Plugin";function v(y,x){v.__super__.constructor.apply(this,arguments)}v.prototype.pluginInit=function(){};return v})(b);o.$=h;o.Delegator=b;o.Range=p;o._t=r;o.supported=function(){return(function(){return !!this.getSelection})()};o.noConflict=function(){a.getGlobal().Annotator=e;return this};h.plugin("annotator",o);this.Annotator=o;o.Widget=(function(w){s(v,w);v.name="Widget";v.prototype.classes={hide:"annotator-hide",invert:{x:"annotator-invert-x",y:"annotator-invert-y"}};function v(y,x){v.__super__.constructor.apply(this,arguments);this.classes=h.extend({},o.Widget.prototype.classes,this.classes)}v.prototype.checkOrientation=function(){var A,B,x,z,y;this.resetOrientation();y=h(a.getGlobal());z=this.element.children(":first");B=z.offset();x={top:y.scrollTop(),right:y.width()+y.scrollLeft()};A={top:B.top,right:B.left+z.width()};if((A.top-x.top)<0){this.invertY()}if((A.right-x.right)>0){this.invertX()}return this};v.prototype.resetOrientation=function(){this.element.removeClass(this.classes.invert.x).removeClass(this.classes.invert.y);return this};v.prototype.invertX=function(){this.element.addClass(this.classes.invert.x);return this};v.prototype.invertY=function(){this.element.addClass(this.classes.invert.y);return this};v.prototype.isInvertedY=function(){return this.element.hasClass(this.classes.invert.y)};v.prototype.isInvertedX=function(){return this.element.hasClass(this.classes.invert.x)};return v})(b);o.Editor=(function(w){s(v,w);v.name="Editor";v.prototype.events={"form submit":"submit",".annotator-save click":"submit",".annotator-cancel click":"hide",".annotator-cancel mouseover":"onCancelButtonMouseover","textarea keydown":"processKeypress"};v.prototype.classes={hide:"annotator-hide",focus:"annotator-focus"};v.prototype.html='<div class="annotator-outer annotator-editor">\n  <form class="annotator-widget">\n    <ul class="annotator-listing"></ul>\n    <div class="annotator-controls">\n      <a href="#cancel" class="annotator-cancel">'+r("Cancel")+'</a>\n<a href="#save" class="annotator-save annotator-focus">'+r("Save")+"</a>\n    </div>\n  </form>\n</div>";v.prototype.options={};function v(x){this.onCancelButtonMouseover=f(this.onCancelButtonMouseover,this);this.processKeypress=f(this.processKeypress,this);this.submit=f(this.submit,this);this.load=f(this.load,this);this.hide=f(this.hide,this);this.show=f(this.show,this);v.__super__.constructor.call(this,h(this.html)[0],x);this.fields=[];this.annotation={}}v.prototype.show=function(x){if(x!=null){x.preventDefault()}this.element.removeClass(this.classes.hide);this.element.find(".annotator-save").addClass(this.classes.focus);this.checkOrientation();this.element.find(":input:first").focus();this.setupDraggables();return this.publish("show")};v.prototype.hide=function(x){if(x!=null){x.preventDefault()}this.element.addClass(this.classes.hide);return this.publish("hide")};v.prototype.load=function(z){var B,A,y,x;this.annotation=z;this.publish("load",[this.annotation]);x=this.fields;for(A=0,y=x.length;A<y;A++){B=x[A];B.load(B.element,this.annotation);if((z.category!=null)&&B.type==="radio"){if(B.value===this.annotation.category){B.element.childNodes[0].checked=true}}}return this.show()};v.prototype.submit=function(A){var B,z,y,x;if(A!=null){A.preventDefault()}x=this.fields;for(z=0,y=x.length;z<y;z++){B=x[z];B.submit(B.element,this.annotation)}this.publish("save",[this.annotation]);return this.hide()};v.prototype.addField=function(y){var z,A,x;A=h.extend({id:"annotator-field-"+a.uuid(),type:"input",label:"",load:function(){},submit:function(){}},y);x=null;z=h('<li class="annotator-item" />');A.element=z[0];switch(A.type){case"textarea":x=h("<textarea />");break;case"input":case"checkbox":x=h("<input />");break;case"radio":x=h('<input type="radio"/>');break;case"span":x=h("<span/>")}z.append(x);x.attr({id:A.id,placeholder:A.label});if(A.type==="span"){z.addClass("annotator-status");z.append(h("<label />",{"for":A.id,html:A.label}))}if(A.type==="checkbox"){x[0].type="checkbox";z.addClass("annotator-checkbox");z.append(h("<label />",{"for":A.id,html:A.label}))}if(A.type==="radio"){x[0].type="radio";x[0].name="radioset";x[0].id=A.value;if(A.checked){x[0].checked=true}z.addClass("annotator-radio");z.append(h("<label />",{"for":A.id,html:A.label}))}this.element.find("ul:first").append(z);this.fields.push(A);return A.element};v.prototype.checkOrientation=function(){var x,y;v.__super__.checkOrientation.apply(this,arguments);y=this.element.find("ul");x=this.element.find(".annotator-controls");if(this.element.hasClass(this.classes.invert.y)){x.insertBefore(y)}else{if(x.is(":first-child")){x.insertAfter(y)}}return this};v.prototype.processKeypress=function(x){if(x.keyCode===27){return this.hide()}else{if(x.keyCode===13&&!x.shiftKey){return this.submit()}}};v.prototype.onCancelButtonMouseover=function(){return this.element.find("."+this.classes.focus).removeClass(this.classes.focus)};v.prototype.setupDraggables=function(){var A,I,z,E,x,C,G,B,y,F,H,D=this;this.element.find(".annotator-resize").remove();if(this.element.hasClass(this.classes.invert.y)){z=this.element.find(".annotator-item:last")}else{z=this.element.find(".annotator-item:first")}if(z){h('<span class="annotator-resize"></span>').appendTo(z)}x=null;A=this.classes;E=this.element;F=null;y=E.find(".annotator-resize");I=E.find(".annotator-controls");H=false;C=function(J){if(J.target===this){x={element:this,top:J.pageY,left:J.pageX};F=E.find("textarea:first");h(window).bind({"mouseup.annotator-editor-resize":B,"mousemove.annotator-editor-resize":G});return J.preventDefault()}};B=function(){x=null;return h(window).unbind(".annotator-editor-resize")};G=function(N){var O,L,K,J,M;if(x&&H===false){O={top:N.pageY-x.top,left:N.pageX-x.left};if(x.element===y[0]){J=F.outerHeight();M=F.outerWidth();L=E.hasClass(A.invert.x)?-1:1;K=E.hasClass(A.invert.y)?1:-1;F.height(J+(O.top*K));F.width(M+(O.left*L));if(F.outerHeight()!==J){x.top=N.pageY}if(F.outerWidth()!==M){x.left=N.pageX}}else{if(x.element===I[0]){E.css({top:parseInt(E.css("top"),10)+O.top,left:parseInt(E.css("left"),10)+O.left});x.top=N.pageY;x.left=N.pageX}}H=true;return setTimeout(function(){return H=false},1000/60)}};y.bind("mousedown",C);return I.bind("mousedown",C)};return v})(o.Widget);o.Viewer=(function(v){s(w,v);w.name="Viewer";w.prototype.events={".annotator-edit click":"onEditClick",".annotator-delete click":"onDeleteClick"};w.prototype.classes={hide:"annotator-hide",showControls:"annotator-visible"};w.prototype.html={element:'<div class="annotator-outer annotator-viewer">\n  <ul class="annotator-widget annotator-listing"></ul>\n</div>',item:'<li class="annotator-annotation annotator-item">\n  <span class="annotator-controls">\n    <button class="annotator-edit">Edit</button>\n    <button class="annotator-delete">Delete</button>\n  </span>\n</li>'};function w(x){this.onDeleteClick=f(this.onDeleteClick,this);this.onEditClick=f(this.onEditClick,this);this.load=f(this.load,this);this.hide=f(this.hide,this);this.show=f(this.show,this);w.__super__.constructor.call(this,h(this.html.element)[0],x);this.item=h(this.html.item)[0];this.fields=[];this.annotations=[]}w.prototype.show=function(y){var x,z=this;a.preventEventDefault(y);x=this.element.find(".annotator-controls").addClass(this.classes.showControls);setTimeout((function(){return x.removeClass(z.classes.showControls)}),500);this.element.removeClass(this.classes.hide);return this.checkOrientation().publish("show")};w.prototype.isShown=function(){return !this.element.hasClass(this.classes.hide)};w.prototype.hide=function(x){a.preventEventDefault(x);this.element.addClass(this.classes.hide);return this.publish("hide")};w.prototype.load=function(x){var F,J,I,H,K,C,A,M,G,B,L,z,y,O,N,E,D;this.annotations=x||[];L=this.element.find("ul:first").empty();E=this.annotations;for(z=0,O=E.length;z<O;z++){F=E[z];M=h(this.item).clone().appendTo(L).data("annotation",F);I=M.find(".annotator-controls");K=I.find(".annotator-edit");H=I.find(".annotator-delete");J={showEdit:function(){return K.removeAttr("disabled")},hideEdit:function(){return K.attr("disabled","disabled")},showDelete:function(){return H.removeAttr("disabled")},hideDelete:function(){return H.attr("disabled","disabled")}};G=I.find(".annotator-link");K=I.find(".annotator-edit");H=I.find(".annotator-delete");B=new g(F.links||[]).get("alternate",{type:"text/html"});if(B.length===0||!(B[0].href!=null)){G.remove()}else{G.attr("href",B[0].href)}if(this.options.readOnly){K.remove();H.remove()}else{J={showEdit:function(){return K.removeAttr("disabled")},hideEdit:function(){return K.attr("disabled","disabled")},showDelete:function(){return H.removeAttr("disabled")},hideDelete:function(){return H.attr("disabled","disabled")}}}D=this.fields;for(y=0,N=D.length;y<N;y++){A=D[y];C=h(A.element).clone().appendTo(M)[0];A.load(C,F,J)}}this.publish("load",[this.annotations]);return this.show()};w.prototype.addField=function(x){var y;y=h.extend({load:function(){}},x);y.element=h("<div />")[0];this.fields.push(y);y.element;return this};w.prototype.onEditClick=function(x){return this.onButtonClick(x,"edit")};w.prototype.onDeleteClick=function(x){return this.onButtonClick(x,"delete")};w.prototype.onButtonClick=function(z,x){var y;y=h(z.target).parents(".annotator-annotation");return this.publish(x,[y.data("annotation")])};return w})(o.Widget);g=(function(){v.name="LinkParser";function v(w){this.data=w}v.prototype.get=function(G,D){var C,A,F,B,E,x,w,z,y;if(D==null){D={}}D=h.extend({},D,{rel:G});F=(function(){var H;H=[];for(A in D){if(!k.call(D,A)){continue}E=D[A];H.push(A)}return H})();z=this.data;y=[];for(x=0,w=z.length;x<w;x++){C=z[x];B=F.reduce((function(H,I){return H&&(C[I]===D[I])}),true);if(B){y.push(C)}else{continue}}return y};return v})();o=o||{};o.Notification=(function(v){s(w,v);w.name="Notification";w.prototype.events={click:"hide"};w.prototype.options={html:"<div class='annotator-notice'></div>",classes:{show:"annotator-notice-show",info:"annotator-notice-info",success:"annotator-notice-success",error:"annotator-notice-error"}};function w(x){this.hide=f(this.hide,this);this.show=f(this.show,this);w.__super__.constructor.call(this,h(this.options.html).appendTo(document.body)[0],x)}w.prototype.show=function(y,x){if(x==null){x=o.Notification.INFO}h(this.element).addClass(this.options.classes.show).addClass(this.options.classes[x]).escape(y||"");setTimeout(this.hide,5000);return this};w.prototype.hide=function(){h(this.element).removeClass(this.options.classes.show);return this};return w})(b);o.Notification.INFO="show";o.Notification.SUCCESS="success";o.Notification.ERROR="error";h(function(){var v;v=new o.Notification;o.showNotification=v.show;return o.hideNotification=v.hide})}).call(this);