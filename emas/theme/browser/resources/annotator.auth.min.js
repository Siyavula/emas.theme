(function(){var d;var b=function(e,f){return function(){return e.apply(f,arguments)}},a=Object.prototype.hasOwnProperty,c=function(h,f){for(var e in f){if(a.call(f,e)){h[e]=f[e]}}function g(){this.constructor=h}g.prototype=f.prototype;h.prototype=new g;h.__super__=f.prototype;return h};d=function(f){var k,e,j,h,i,g;h="([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?";k=f.match(new RegExp(h));j=0;e=new Date(k[1],0,1);if(k[3]){e.setMonth(k[3]-1)}if(k[5]){e.setDate(k[5])}if(k[7]){e.setHours(k[7])}if(k[8]){e.setMinutes(k[8])}if(k[10]){e.setSeconds(k[10])}if(k[12]){e.setMilliseconds(Number("0."+k[12])*1000)}if(k[14]){j=(Number(k[16])*60)+Number(k[17]);j*=(g=k[15]==="-")!=null?g:{1:-1}}j-=e.getTimezoneOffset();i=Number(e)+(j*60*1000);e.setTime(Number(i));return e};Annotator.Plugin.Auth=(function(){c(e,Annotator.Plugin);e.prototype.options={token:null,tokenUrl:"/auth/token",autoFetch:true};function e(g,f){this.haveValidToken=b(this.haveValidToken,this);e.__super__.constructor.apply(this,arguments);this.element.data("annotator:auth",this);this.waitingForToken=[];if(this.options.token){this.setToken(this.options.token)}else{this.requestToken()}}e.prototype.requestToken=function(){this.requestInProgress=true;return $.getJSON(this.options.tokenUrl,b(function(g,f,h){if(f!=="success"){return console.error("Couldn't get auth token: "+f,h)}else{this.setToken(g);return this.requestInProgress=false}},this))};e.prototype.setToken=function(g){var f;this.token=g;if(this.haveValidToken()){if(this.options.autoFetch){this.refreshTimeout=setTimeout((b(function(){return this.requestToken()},this)),(this.timeToExpiry()-2)*1000)}this.updateHeaders();f=[];while(this.waitingForToken.length>0){f.push(this.waitingForToken.pop().apply())}return f}else{console.warn("Didn't get a valid token.");if(this.options.autoFetch){console.warn("Getting a new token in 10s.");return setTimeout((b(function(){return this.requestToken()},this)),10*1000)}}};e.prototype.haveValidToken=function(){var f;f=this.token&&this.token.authToken&&this.token.authTokenIssueTime&&this.token.authTokenTTL&&this.token.accountId&&this.token.userId;return f&&this.timeToExpiry()>0};e.prototype.timeToExpiry=function(){var h,f,g,i;g=new Date().getTime()/1000;f=d(this.token.authTokenIssueTime).getTime()/1000;h=f+this.token.authTokenTTL;i=h-g;if(i>0){return i}else{return 0}};e.prototype.updateHeaders=function(){var f;f=this.element.data("annotator:headers");return this.element.data("annotator:headers",$.extend(f,{"x-annotator-auth-token":this.token.authToken,"x-annotator-auth-token-issue-time":this.token.authTokenIssueTime,"x-annotator-auth-token-ttl":this.token.authTokenTTL,"x-annotator-account-id":this.token.accountId,"x-annotator-user-id":this.token.userId}))};e.prototype.withToken=function(f){if(!(f!=null)){return}if(this.haveValidToken()){return f()}else{this.waitingForToken.push(f);if(!this.requestInProgress){return this.requestToken()}}};return e})()}).call(this);