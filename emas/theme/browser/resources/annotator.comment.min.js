(function(){var b=function(e,f){return function(){return e.apply(f,arguments)}},a={}.hasOwnProperty,d=function(h,f){for(var e in f){if(a.call(f,e)){h[e]=f[e]}}function g(){this.constructor=h}g.prototype=f.prototype;h.prototype=new g;h.__super__=f.prototype;return h},c=[].indexOf||function(g){for(var f=0,e=this.length;f<e;f++){if(f in this&&this[f]===g){return f}}return -1};Annotator.Plugin.Comment=(function(e){d(f,e);f.name="Comment";f.prototype.events={annotationViewerShown:"addReplyButton",".annotator-reply-save click":"onReplyEntryClick",".annotator-cancel click":"hide",".replyentry keydown":"processKeypress",".replyentry click":"processKeypress",".annotator-delete-reply click":"deleteReply"};function f(g){this.processKeypress=b(this.processKeypress,this);f.__super__.constructor.apply(this,arguments)}f.prototype.pluginInit=function(){if(!Annotator.supported()){}};f.prototype.addReplyButton=function(n,h){var w,o,v,u,t,q,g,x,m,k,j,y,A,z,s,p;o=this.annotator.element.find(".annotator-annotation.annotator-item");for(v=m=0,y=o.length;m<y;v=++m){u=o[v];u=$(u);this.replies=[];x=this.annotator.dumpAnnotations();try{g=x.sort(function(l,i){if(l.created.toUpperCase()>=i.created.toUpperCase()){return 1}else{return -1}})}catch(r){g=x}s=g.reverse();for(k=0,A=s.length;k<A;k++){w=s[k];if(w.parent!=null){if(w.parent===h[v].id){this.replies.push(w.reply)}}}if(this.replies.length>0){u.append('<div style=\'padding:5px\'> <span> Replies </span></div>\n  <div id="Replies">\n\n<li class="Replies">\n</li></div>')}if(this.replies.length>0){q=this.annotator.element.find(".Replies");p=this.replies.reverse();for(j=0,z=p.length;j<z;j++){t=p[j];$(q[v]).append("<div class='reply'>\n<span class='replyuser'>"+t.user.name+"</span><button TITLE=\"Delete\" class='annotator-delete-reply'>x</button><div class='replytext'>"+t.reply+"</div></div>")}}u.append('<div class=\'replybox\'>\n<textarea class="replyentry" placeholder="Reply to this annotation..."></textarea>')}return n.checkOrientation()};f.prototype.onReplyEntryClick=function(l){var k,h,j,i,g;k=$(l.target).parent().parent();g=k.find(".replyentry");j=g.val();if(j!==""){i=this.getReplyObject();if(this.annotator.plugins.Permissions.user){i.user=this.annotator.plugins.Permissions.user.name}else{i.user="Anonymous"}i.reply=j;k=$(l.target).parents(".annotator-annotation");h=this.annotator.createAnnotation();h.ranges=[];h.parent=k.data("annotation").id;h.highlights=k.data("annotation").highlights;i=this.getReplyObject();i.user=h.user;i.reply=j;h.reply=i;h=this.annotator.setupAnnotation(h);this.notify(h,l);return this.annotator.viewer.hide()}};f.prototype.deleteReply=function(h){var g,l,n,m,j,o,k,i;n=$(h.target).parents(".reply");l=n.parents(".annotator-annotation").data("annotation").id;m=n.find(".replytext")[0].innerHTML;k=this.annotator.dumpAnnotations();i=[];for(j=0,o=k.length;j<o;j++){g=k[j];if(g.parent===l){if(g.reply.reply===m){g.highlights=[];this.annotator.deleteAnnotation(g);$(n).replaceWith("");break}else{i.push(void 0)}}else{i.push(void 0)}}return i};f.prototype.getReplyObject=function(){var g;g={user:"anonymous",reply:""};return g};f.prototype.processKeypress=function(i){var g,h;h=$(i.target).parent();g=h.find(".annotator-reply-controls");if(g.length===0){h.append('<div class="annotator-reply-controls">\n<a href="#save" class="annotator-reply-save">Save</a>\n<a href="#cancel" class="annotator-cancel">Cancel</a>\n</div>\n</div>');this.annotator.viewer.checkOrientation()}if(i.keyCode===27){return this.annotator.viewer.hide()}else{if(i.keyCode===13&&!i.shiftKey){return this.onReplyEntryClick(i)}}};f.prototype.hide=function(){return this.annotator.viewer.hide()};f.prototype.notify=function(i,h){var q,o,g,l,n,k,p,m,j;n=i.user.id;o=[];m=this.replies;for(k=0,p=m.length;k<p;k++){g=m[k];if(g.user.name!==n){if(j=g.user.name,c.call(o,j)<0){o.push(g.user.name)}}}l=$(h.target).parents();q=l.parents(".annotator-annotation").data("annotation").user.id;if(c.call(o,q)<0){o.push(q)}return $.ajax("@@annotator-notify-json",{data:{email_list:o,ann_url:$(location).attr("href"),ann_message:i.reply.reply,name:n},dataType:"json",success:function(s,r,t){},error:function(t,r,s){},complete:function(s,r){}})};return f})(Annotator.Plugin)}).call(this);