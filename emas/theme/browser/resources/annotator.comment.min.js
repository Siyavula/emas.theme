(function(){var b=function(d,e){return function(){return d.apply(e,arguments)}},a={}.hasOwnProperty,c=function(g,e){for(var d in e){if(a.call(e,d)){g[d]=e[d]}}function f(){this.constructor=g}f.prototype=e.prototype;g.prototype=new f;g.__super__=e.prototype;return g};Annotator.Plugin.Comment=(function(d){c(e,d);e.name="Comment";e.prototype.events={annotationViewerShown:"addReplyButton",".annotator-reply-save click":"onReplyEntryClick",".annotator-cancel click":"hide",".replyentry keydown":"processKeypress",".replyentry click":"processKeypress",".annotator-delete-reply click":"deleteReply"};function e(f){this.processKeypress=b(this.processKeypress,this);e.__super__.constructor.apply(this,arguments)}e.prototype.pluginInit=function(){if(!Annotator.supported()){}};e.prototype.addReplyButton=function(m,g){var w,n,v,u,t,s,p,f,x,k,j,h,y,A,z,r,o;n=this.annotator.element.find(".annotator-annotation.annotator-item");for(v=k=0,y=n.length;k<y;v=++k){u=n[v];u=$(u);t=[];x=this.annotator.dumpAnnotations();try{f=x.sort(function(l,i){if(l.created.toUpperCase()>=i.created.toUpperCase()){return 1}else{return -1}})}catch(q){f=x}r=f.reverse();for(j=0,A=r.length;j<A;j++){w=r[j];if(w.parent!=null){if(w.parent===g[v].id){t.push(w.reply)}}}if(t.length>0){u.append('<div style=\'padding:5px\'> <span> Replies </span></div>\n  <div id="Replies">\n\n<li class="Replies">\n</li></div>')}if(t.length>0){p=this.annotator.element.find(".Replies");o=t.reverse();for(h=0,z=o.length;h<z;h++){s=o[h];$(p[v]).append("<div class='reply'>\n<span class='replyuser'>"+s.user.name+"</span><button TITLE=\"Delete\" class='annotator-delete-reply'>x</button><div class='replytext'>"+s.reply+"</div></div>")}}u.append('<div class=\'replybox\'>\n<textarea class="replyentry" placeholder="Reply to this annotation..."></textarea>')}return m.checkOrientation()};e.prototype.onReplyEntryClick=function(k){var j,g,i,h,f;j=$(k.target).parent().parent();f=j.find(".replyentry");i=f.val();if(i!==""){h=this.getReplyObject();if(this.annotator.plugins.Permissions.user){h.user=this.annotator.plugins.Permissions.user.name}else{h.user="Anonymous"}h.reply=i;j=$(k.target).parents(".annotator-annotation");g=this.annotator.createAnnotation();g.ranges=[];g.parent=j.data("annotation").id;g.highlights=j.data("annotation").highlights;h=this.getReplyObject();h.user=g.user;h.reply=i;g.reply=h;g=this.annotator.setupAnnotation(g);console.log("setup complete",g);return this.annotator.viewer.hide()}};e.prototype.deleteReply=function(g){var f,k,m,l,i,n,j,h;m=$(g.target).parents(".reply");k=m.parents(".annotator-annotation").data("annotation").id;l=m.find(".replytext")[0].innerHTML;j=this.annotator.dumpAnnotations();h=[];for(i=0,n=j.length;i<n;i++){f=j[i];if(f.parent===k){if(f.reply.reply===l){f.highlights=[];this.annotator.deleteAnnotation(f);$(m).replaceWith("");break}else{h.push(void 0)}}else{h.push(void 0)}}return h};e.prototype.getReplyObject=function(){var f;f={user:"anonymous",reply:""};return f};e.prototype.processKeypress=function(h){var f,g;g=$(h.target).parent();f=g.find(".annotator-reply-controls");if(f.length===0){g.append('<div class="annotator-reply-controls">\n<a href="#save" class="annotator-reply-save">Save</a>\n<a href="#cancel" class="annotator-cancel">Cancel</a>\n</div>\n</div>');this.annotator.viewer.checkOrientation()}if(h.keyCode===27){return this.annotator.viewer.hide()}else{if(h.keyCode===13&&!h.shiftKey){return this.onReplyEntryClick(h)}}};e.prototype.hide=function(){return this.annotator.viewer.hide()};return e})(Annotator.Plugin)}).call(this);