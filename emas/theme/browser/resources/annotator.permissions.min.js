(function(){var b=function(d,e){return function(){return d.apply(e,arguments)}},a=Object.prototype.hasOwnProperty,c=function(g,e){for(var d in e){if(a.call(e,d)){g[d]=e[d]}}function f(){this.constructor=g}f.prototype=e.prototype;g.prototype=new f;g.__super__=e.prototype;return g};Annotator.Plugin.Permissions=(function(){c(d,Annotator.Plugin);d.prototype.events={beforeAnnotationCreated:"addFieldsToAnnotation"};d.prototype.options={showViewPermissionsCheckbox:true,showEditPermissionsCheckbox:true,userId:function(e){return e},userString:function(e){return e},userAuthorize:function(e,f){return this.userId(e)===f},user:"",permissions:{read:[],update:[],"delete":[],admin:[]}};function d(f,e){this.updateViewer=b(this.updateViewer,this);this.updateAnnotationPermissions=b(this.updateAnnotationPermissions,this);this.updatePermissionsField=b(this.updatePermissionsField,this);this.addFieldsToAnnotation=b(this.addFieldsToAnnotation,this);d.__super__.constructor.apply(this,arguments);if(this.options.user){this.setUser(this.options.user);delete this.options.user}}d.prototype.pluginInit=function(){var e,f;if(!Annotator.supported()){return}f=this;e=function(h,g){return function(j,i){return f[h].call(f,g,j,i)}};if(this.options.showViewPermissionsCheckbox===true){this.annotator.editor.addField({type:"checkbox",label:"Allow anyone to <strong>view</strong> this annotation",load:e("updatePermissionsField","read"),submit:e("updateAnnotationPermissions","read")})}if(this.options.showEditPermissionsCheckbox===true){this.annotator.editor.addField({type:"checkbox",label:"Allow anyone to <strong>edit</strong> this annotation",load:e("updatePermissionsField","update"),submit:e("updateAnnotationPermissions","update")})}this.annotator.viewer.addField({load:this.updateViewer});if(this.annotator.plugins.Filter){return this.annotator.plugins.Filter.addFilter({label:"User",property:"user",isFiltered:b(function(j,i){var h,l,g,k;i=this.options.userString(i);if(!(j&&i)){return false}k=j.split(/\s*/);for(l=0,g=k.length;l<g;l++){h=k[l];if(i.indexOf(h)===-1){return false}}return true},this)})}};d.prototype.setUser=function(e){return this.user=e};d.prototype.addFieldsToAnnotation=function(e){if(e){e.permissions=this.options.permissions;if(this.user){return e.user=this.user}}};d.prototype.authorize=function(j,e,g){var h,k,i,f;if(g===void 0){g=this.user}if(e.permissions){k=e.permissions[j]||[];if(k.length===0){return true}for(i=0,f=k.length;i<f;i++){h=k[i];if(this.options.userAuthorize.call(this.options,g,h)){return true}}return false}else{if(e.user){return g&&this.options.userId(g)===e.user}}return true};d.prototype.updatePermissionsField=function(g,i,e){var h,f;i=$(i).show();f=i.find("input").removeAttr("disabled");if(!this.authorize("admin",e)){i.hide()}if(this.authorize(g,e||{},null)){f.attr("checked","checked");h={permissions:this.options.permissions};if(this.authorize(g,h,null)){return f.attr("disabled","disabled")}}else{return f.removeAttr("checked")}};d.prototype.updateAnnotationPermissions=function(g,h,e){var i,f;if(!e.permissions){e.permissions=this.options.permissions}i=g+"-permissions";if($(h).find("input").is(":checked")){$.data(e,i,e.permissions[g]);return e.permissions[g]=[]}else{f=$.data(e,i);if(f){return e.permissions[g]=f}}};d.prototype.updateViewer=function(h,e,g){var f,i;h=$(h);i=this.options.userString(e.user);if(e.user&&i&&typeof i==="string"){f=Annotator.$.escape(this.options.userString(e.user));h.html(f).addClass("annotator-user")}else{h.remove()}if(e.permissions){if(!this.authorize("update",e)){g.hideEdit()}if(!this.authorize("delete",e)){return g.hideDelete()}}else{if(e.user&&!this.authorize(null,e)){g.hideEdit();return g.hideDelete()}}};return d})()}).call(this);