(function(){var b=function(e,f){return function(){return e.apply(f,arguments)}},a={}.hasOwnProperty,d=function(h,f){for(var e in f){if(a.call(f,e)){h[e]=f[e]}}function g(){this.constructor=h}g.prototype=f.prototype;h.prototype=new g;h.__super__=f.prototype;return h},c=[].indexOf||function(g){for(var f=0,e=this.length;f<e;f++){if(f in this&&this[f]===g){return f}}return -1};Annotator.Plugin.Store=(function(e){d(f,e);f.name="Store";f.prototype.events={annotationCreated:"annotationCreated",annotationDeleted:"annotationDeleted",annotationUpdated:"annotationUpdated"};f.prototype.options={prefix:"/store",autoFetch:true,annotationData:{},loadFromSearch:false,urls:{create:"/annotations",read:"/annotations/:id",update:"/annotations/:id",destroy:"/annotations/:id",search:"/search"}};function f(h,g){this._onError=b(this._onError,this);this._onLoadAnnotationsFromSearch=b(this._onLoadAnnotationsFromSearch,this);this._onLoadAnnotations=b(this._onLoadAnnotations,this);this._getAnnotations=b(this._getAnnotations,this);f.__super__.constructor.apply(this,arguments);this.annotations=[]}f.prototype.pluginInit=function(){if(!Annotator.supported()){return}if(this.annotator.plugins.Auth){return this.annotator.plugins.Auth.withToken(this._getAnnotations)}else{return this._getAnnotations()}};f.prototype._getAnnotations=function(){if(this.options.loadFromSearch){return this.loadAnnotationsFromSearch(this.options.loadFromSearch)}else{return this.loadAnnotations()}};f.prototype.annotationCreated=function(g){var h=this;if(c.call(this.annotations,g)<0){this.registerAnnotation(g);return this._apiRequest("create",g,function(i){if(!(i.id!=null)){console.warn(Annotator._t("Warning: No ID returned from server for annotation "),g)}return h.updateAnnotation(g,i)})}else{return this.updateAnnotation(g,{})}};f.prototype.annotationUpdated=function(g){var h=this;if(c.call(this.annotations,g)>=0){return this._apiRequest("update",g,(function(i){return h.updateAnnotation(g,i)}))}};f.prototype.annotationDeleted=function(g){var j,l,i,k,h,m=this;k=this.annotations;h=[];for(l=0,i=k.length;l<i;l++){j=k[l];if(g.id===j.id){g=j;this._apiRequest("destroy",g,(function(){return m.unregisterAnnotation(g)}));break}else{h.push(void 0)}}return h};f.prototype.registerAnnotation=function(g){return this.annotations.push(g)};f.prototype.unregisterAnnotation=function(g){return this.annotations.splice(this.annotations.indexOf(g),1)};f.prototype.updateAnnotation=function(g,h){if(c.call(this.annotations,g)<0){console.error(Annotator._t("Trying to update unregistered annotation!"))}else{$.extend(g,h)}return $(g.highlights).data("annotation",g)};f.prototype.loadAnnotations=function(){return this._apiRequest("read",null,this._onLoadAnnotations)};f.prototype._onLoadAnnotations=function(g){if(g==null){g=[]}this.annotations=g;return this.annotator.loadAnnotations(g.slice())};f.prototype.loadAnnotationsFromSearch=function(g){return this._apiRequest("search",g,this._onLoadAnnotationsFromSearch)};f.prototype._onLoadAnnotationsFromSearch=function(g){if(g==null){g={}}return this._onLoadAnnotations(g.rows||[])};f.prototype.dumpAnnotations=function(){var k,j,h,i,g;i=this.annotations;g=[];for(j=0,h=i.length;j<h;j++){k=i[j];g.push(JSON.parse(this._dataFor(k)))}return g};f.prototype._apiRequest=function(j,k,l){var m,h,i,g;m=k&&k.id;g=this._urlFor(j,m);h=this._apiRequestOptions(j,k,l);i=$.ajax(g,h);i._id=m;i._action=j;return i};f.prototype._apiRequestOptions=function(h,i,j){var g;g={type:this._methodFor(h),headers:this.element.data("annotator:headers"),dataType:"json",success:j||function(){},error:this._onError};if(h==="search"){g=$.extend(g,{data:i})}else{g=$.extend(g,{data:i&&this._dataFor(i),contentType:"application/json; charset=utf-8"})}return g};f.prototype._urlFor=function(i,j){var g,h;g=j!=null?"/"+j:"";h=this.options.prefix||"/";h+=this.options.urls[i];h=h.replace(/\/:id/,g);return h};f.prototype._methodFor=function(h){var g;g={create:"POST",read:"GET",update:"PUT",destroy:"DELETE",search:"GET"};return g[h]};f.prototype._dataFor=function(g){var h,i;i=g.highlights;delete g.highlights;$.extend(g,this.options.annotationData);h=JSON.stringify(g);if(i){g.highlights=i}return h};f.prototype._onError=function(i){var h,g;h=i._action;g=Annotator._t("Sorry we could not ")+h+Annotator._t(" this annotation");if(i._action==="search"){g=Annotator._t("Sorry we could not search the store for annotations")}else{if(i._action==="read"&&!i._id){g=Annotator._t("Sorry we could not ")+h+Annotator._t(" the annotations from the store")}}switch(i.status){case 401:g=Annotator._t("Sorry you are not allowed to ")+h+Annotator._t(" this annotation");break;case 404:g=Annotator._t("Sorry we could not connect to the annotations store");break;case 500:g=Annotator._t("Sorry something went wrong with the annotation store")}Annotator.showNotification(g,Annotator.Notification.ERROR);return console.error(Annotator._t("API request failed:")+(" '"+i.status+"'"))};return f})(Annotator.Plugin)}).call(this);